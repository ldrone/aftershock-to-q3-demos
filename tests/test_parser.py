from parser import Parser

import pytest
from bitarray import bitarray
from message import Message
from protocol.aftershock import Aftershock


@pytest.fixture
def data_player_stats():
    return bitarray(
        """
        1100110000100111101100000111001100110101111000110001111000001110
        0111011000000111100001100010100011111100110011000001000111110110
        0011001001010001001111111001010101011100010100011001000010111000
        1000011101101001010111000100010000011111011111100011101011001101
        0001011111000010110010111111010111111100010011111101101101001001
        1110011000010101010001010111000100111111001111011101111110110001
        1101011101010100111001001001101011011000100101000111100011100111
        1010111110000011010011100111110000011010010001110100111110101101
        1001101010011110100100100100100100110001101011101110111001011111
        0011110110111111010100010000010010010011000111110111000100110110
        0101101100010000111101001001100101101111101110100100100100100100
        0011111001100001111100100001111110011000111111001011001111110011
        1100111111000111010100010011110101000100001100010011000111000100
        1100110010111100000110101111000011100001000111100001000001111001
        0000011111001000011111100100000000101011000100101011001111101100
        0011001011000010110010110000011100101100001111001011000000001000
        1000010001000100000100100010000110010001000000101000111100101010
        0011110001101000111100111011000011000110110011110011101100111100
        0000101001000110010100100000001101011000100011010110001011101001
        1001100100110101000000
        """,
        endian='little',
    )


def test_parser_player_state(data_player_stats):
    m = Message(data_player_stats)
    p = Parser(None)

    p._demo.game_protocol = Aftershock
    p._msg = Message(data_player_stats)
    p._parse_player_state()
    assert m.player_state_delta == {
        'commandTime': 7292859,
        'origin0': -319.5539855957031,  # -319.553986
        'origin1': -207.14320373535156,  # -207.143204
        'viewangles1': 80.211181640625,  # 80.211182
        'viewangles0': 18.0999755859375,  # 18.099976
        'weaponTime': 5,
        'origin2': 408.125,  # 408.125000
        'legsTimer': 50,
        'pm_time': 170,
        'eventSequence': 201,
        'torsoAnim': 135,
        'events0': 10,
        'legsAnim': 147,
        'events1': 23,
        'pm_flags': 32,
        'groundEntityNum': 1022,
        'weaponstate': 3,
        'eFlags': 4,
        'gravity': 757,
        'speed': 320,
        'delta_angles1': 32768,
        'externalEventParm': 85,
        'viewheight': 26,
        'damageEvent': 12,
        'damageYaw': 41,
        'damagePitch': 225,  # not present with cl_shownet 2
        'damageCount': 47,  # not present with cl_shownet 2
        'delta_angles0': 33632,  # not present with cl_shownet 2
        'weapon': 5,  # not present with cl_shownet 2
    }
